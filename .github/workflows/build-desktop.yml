name: Build and Release Desktop Apps

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build:
    name: Build + Smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            npm_script: dist:mac
            artifact_name: lcms-desktop-macos
          - os: windows-latest
            npm_script: dist:win
            artifact_name: lcms-desktop-windows

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Node dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller

      - name: Build desktop artifacts
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
        run: npm run ${{ matrix.npm_script }}

      - name: Smoke test macOS package
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          SMOKE_PORT=18741

          ZIP_FILE="$(ls release/*-mac.zip | head -n1)"
          DMG_FILE="$(ls release/*.dmg | head -n1)"

          if [[ -z "${ZIP_FILE:-}" || -z "${DMG_FILE:-}" ]]; then
            echo "Missing macOS release artifacts in release/."
            exit 1
          fi

          SMOKE_DIR="smoke/macos"
          rm -rf "$SMOKE_DIR"
          mkdir -p "$SMOKE_DIR"
          unzip -q "$ZIP_FILE" -d "$SMOKE_DIR"

          BACKEND_BIN="$(find "$SMOKE_DIR" -type f -path '*/Contents/Resources/backend/lcms-backend' | head -n1)"
          if [[ -z "${BACKEND_BIN:-}" ]]; then
            echo "Could not find packaged backend binary in macOS app zip."
            exit 1
          fi

          LCMS_PORT="$SMOKE_PORT" "$BACKEND_BIN" > "$SMOKE_DIR/backend.log" 2>&1 &
          BACKEND_PID=$!
          cleanup() {
            kill "$BACKEND_PID" >/dev/null 2>&1 || true
            wait "$BACKEND_PID" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          OK=0
          for _ in {1..90}; do
            if curl -fsS "http://127.0.0.1:${SMOKE_PORT}/api/health" > "$SMOKE_DIR/health.json"; then
              OK=1
              break
            fi
            if ! kill -0 "$BACKEND_PID" >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          if [[ "$OK" -ne 1 ]]; then
            echo "Smoke test failed: packaged backend did not answer /api/health"
            echo "Backend process running? $(kill -0 "$BACKEND_PID" >/dev/null 2>&1 && echo yes || echo no)"
            echo "Backend log:"
            cat "$SMOKE_DIR/backend.log" || true
            exit 1
          fi

          cat "$SMOKE_DIR/health.json"

      - name: Smoke test Windows package
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $port = 18741

          $zipFile = Get-ChildItem -Path release -Filter '*-win.zip' -Recurse | Select-Object -First 1
          $exeFile = Get-ChildItem -Path release -Filter '*.exe' -Recurse | Select-Object -First 1
          if (-not $zipFile) {
            throw "Missing Windows zip artifact in release/."
          }
          if (-not $exeFile) {
            throw "Missing Windows executable artifact in release/."
          }

          $smokeDir = Join-Path $env:RUNNER_TEMP 'lcms-smoke-win'
          if (Test-Path $smokeDir) {
            Remove-Item -Path $smokeDir -Recurse -Force
          }
          Expand-Archive -Path $zipFile.FullName -DestinationPath $smokeDir -Force

          $backendExe = Get-ChildItem -Path $smokeDir -Filter 'lcms-backend.exe' -Recurse | Select-Object -First 1
          if (-not $backendExe) {
            throw "Could not find packaged backend binary in Windows app zip."
          }

          $stdoutLog = Join-Path $smokeDir 'backend.stdout.log'
          $stderrLog = Join-Path $smokeDir 'backend.stderr.log'
          if (Test-Path $stdoutLog) { Remove-Item -Path $stdoutLog -Force }
          if (Test-Path $stderrLog) { Remove-Item -Path $stderrLog -Force }

          $env:LCMS_PORT = "$port"
          $proc = Start-Process `
            -FilePath $backendExe.FullName `
            -WorkingDirectory $backendExe.Directory.FullName `
            -PassThru `
            -WindowStyle Hidden `
            -RedirectStandardOutput $stdoutLog `
            -RedirectStandardError $stderrLog

          try {
            $ok = $false
            $health = $null
            for ($i = 0; $i -lt 90; $i++) {
              try {
                $health = Invoke-RestMethod -Uri "http://127.0.0.1:$port/api/health" -TimeoutSec 2
                if ($health.status -eq 'ok') {
                  $ok = $true
                  break
                }
              } catch {
              }
              if ($proc.HasExited) {
                break
              }
              Start-Sleep -Seconds 1
            }

            if (-not $ok) {
              Write-Host "Backend process exited: $($proc.HasExited) ExitCode: $($proc.ExitCode)"
              if (Test-Path $stdoutLog) {
                Write-Host "--- backend stdout ---"
                Get-Content -Path $stdoutLog -Tail 200 | ForEach-Object { Write-Host $_ }
              }
              if (Test-Path $stderrLog) {
                Write-Host "--- backend stderr ---"
                Get-Content -Path $stderrLog -Tail 200 | ForEach-Object { Write-Host $_ }
              }
              throw "Smoke test failed: packaged backend did not answer /api/health"
            }

            Write-Host ($health | ConvertTo-Json -Compress)
          }
          finally {
            if ($proc -and -not $proc.HasExited) {
              Stop-Process -Id $proc.Id -Force
            }
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          if-no-files-found: error
          path: |
            release/*.dmg
            release/*-mac.zip
            release/*-win.zip
            release/LCMS*.exe
            release/latest*.yml
            release/app-update.yml

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: lcms-desktop-*
          merge-multiple: true
          path: release-assets

      - name: Show release files
        run: find release-assets -type f | sort

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            release-assets/*.dmg
            release-assets/*-mac.zip
            release-assets/*-win.zip
            release-assets/LCMS*.exe
            release-assets/latest*.yml
            release-assets/app-update.yml
            README.md
